import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go

# --- é é¢è¨­å®š ---
st.set_page_config(page_title="å°è‚¡ AI æˆ°æƒ…å®¤ 2.0", layout="wide", page_icon="ğŸ¢")

# --- æ•¸æ“šæŠ“å–å‡½æ•¸ (å„ªåŒ–ç‰ˆ) ---
@st.cache_data(ttl=3600)
def get_war_room_data(sid):
    sid = sid.strip().upper()
    for suffix in [".TW", ".TWO"]:
        target_id = f"{sid}{suffix}"
        try:
            ticker = yf.Ticker(target_id)
            df = ticker.history(period="1y")
            if not df.empty:
                try:
                    s_name = ticker.info.get('shortName') or ticker.info.get('longName') or sid
                except:
                    s_name = sid
                return df, target_id, s_name
        except:
            continue
    return pd.DataFrame(), None, None

# --- å´é‚Šæ¬„ï¼šä½¿ç”¨è€…åˆ†çµ„ ---
st.sidebar.header("ğŸ‘¤ ç›£æ§æ¸…å–®åˆ†çµ„")
group_choice = st.sidebar.selectbox("åˆ‡æ›ç¾¤çµ„", ["æ ¸å¿ƒæŒè‚¡", "è§€å¯Ÿæ¸…å–®", "è‡ªå®šç¾©"])

# ä¸åŒç¾¤çµ„çš„åˆå§‹è¨­å®š
default_map = {
    "æ ¸å¿ƒæŒè‚¡": "2330, 5498, 6182",
    "è§€å¯Ÿæ¸…å–®": "2454, 2317, 2603, 2609",
    "è‡ªå®šç¾©": ""
}

watchlist_input = st.sidebar.text_area("ç·¨è¼¯æœ¬çµ„ä»£è™Ÿ (é€—è™Ÿéš”é–‹)", value=default_map[group_choice])
stocks = [s.strip() for s in watchlist_input.split(",") if s.strip()]

# --- ä¸»ä»‹é¢ ---
st.title(f"ğŸ¢ å°è‚¡æˆ°æƒ…å®¤ - {group_choice}")

if not stocks:
    st.info("ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿé–‹å§‹ç›£æ§")
else:
    # 1. å„€è¡¨æ¿ç¸½è¦½
    summary_data = []
    with st.spinner('æƒæå¸‚å ´è¶¨å‹¢ä¸­...'):
        for s in stocks:
            df, tid, name = get_war_room_data(s)
            if not df.empty:
                cp = df['Close'].iloc[-1]
                m5 = df['Close'].rolling(5).mean().iloc[-1]
                m13 = df['Close'].rolling(13).mean().iloc[-1]
                m37 = df['Close'].rolling(37).mean().iloc[-1]
                vol = df['Volume'].iloc[-1]
                bias = ((cp - m5) / m5) * 100
                
                # AI ç‡ˆè™Ÿåˆ¤æ–·
                if cp > m5 > m13 > m37:
                    status = "ğŸŸ¢ å¤šé ­å¼·å‹¢"
                elif cp < m37:
                    status = "ğŸ”´ è¶¨å‹¢è½‰ç©º"
                elif cp < m5:
                    status = "ğŸŸ¡ çŸ­æœŸä¿®æ­£"
                else:
                    status = "âšª éœ‡ç›ªæ•´ç†"
                
                summary_data.append({
                    "åç¨±": name, "ä»£è™Ÿ": s, "ç›®å‰è‚¡åƒ¹": f"{cp:.2f}",
                    "5MAä¹–é›¢": f"{bias:.2f}%", "æˆäº¤é‡(è‚¡)": f"{vol:,.0f}", "AI ç‡ˆè™Ÿ": status
                })

    # é¡¯ç¤ºç›£æ§è¡¨æ ¼
    st.subheader("ğŸ“Š å…¨çƒæ¸…å–®å³æ™‚ç‹€æ…‹")
    st.dataframe(pd.DataFrame(summary_data), use_container_width=True, hide_index=True)

    st.divider()

    # 2. å¿«é€Ÿåˆ‡æ›è¨ºæ–·
    st.subheader("ğŸ” å¿«é€Ÿå€‹è‚¡è¨ºæ–·")
    target = st.selectbox("é»æ“Šåˆ‡æ›æŸ¥çœ‹è©³ç´° K ç·šåœ–", stocks)
    
    if target:
        df, tid, name = get_war_room_data(target)
        if not df.empty:
            df['5MA'] = df['Close'].rolling(5).mean()
            df['13MA'] = df['Close'].rolling(13).mean()
            df['37MA'] = df['Close'].rolling(37).mean()
            
            fig = go.Figure()
            fig.add_trace(go.Candlestick(x=df.index, open=df['Open'], high=df['High'], low=df['Low'], close=df['Close'], name='Kç·š'))
            fig.add_trace(go.Scatter(x=df.index, y=df['5MA'], line=dict(color='#00BFFF'), name='5MA'))
            fig.add_trace(go.Scatter(x=df.index, y=df['37MA'], line=dict(color='#BA55D3'), name='37MA'))
            fig.update_layout(height=450, template="plotly_dark", xaxis_rangeslider_visible=False)
            st.plotly_chart(fig, use_container_width=True)
            
            # ç°¡æ½” AI å»ºè­°
            if df['Close'].iloc[-1] > df['37MA'].iloc[-1]:
                st.success(f"ğŸ“ˆ {name} ä¸­æœŸè¶¨å‹¢å‘ä¸Šï¼Œå»ºè­°æŒè‚¡çºŒæŠ±ã€‚")
            else:
                st.error(f"ğŸ“‰ {name} è™•æ–¼ä¸­æœŸç©ºé ­ï¼Œå»ºè­°æ¸›ç¢¼è§€æœ›ã€‚")